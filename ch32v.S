LDEFCONST RCC_BASE, 0x40021000
LDEFCONST R32_RCC_CTLR,  0x00
LDEFCONST RCC_HSION, (1 << 0)
LDEFCONST RCC_HSIRDY, (1 << 1)
LDEFCONST RCC_PLLON, (1 << 24)
LDEFCONST RCC_PLLRDY, (1 << 25)
LDEFCONST R32_RCC_CFGR0, 0x04
LDEFCONST RCC_SW_MASK, (0x3 << 0)
LDEFCONST RCC_SW_HSI, (0x0 << 0)
LDEFCONST RCC_SW_PLL, (0x2 << 0)
LDEFCONST RCC_SWS_MASK, (0x3 << 2)
LDEFCONST RCC_SWS_HSI, (0x0 << 2)
LDEFCONST RCC_SWS_PLL, (0x2 << 2)
LDEFCONST RCC_HPRE_MASK, (0xF << 4)
LDEFCONST RCC_HPRE_DIV1, (0x0 << 4)
LDEFCONST RCC_PPRE1_MASK, (0x7 << 8)
LDEFCONST RCC_PPRE1_DIV1, (0x0 << 8)
LDEFCONST RCC_PPRE2_MASK, (0x7 << 11)
LDEFCONST RCC_PPRE2_DIV1, (0x0 << 11)
LDEFCONST RCC_PLLSRC_MASK, (0x1 << 16)
LDEFCONST RCC_PLLSRC_HSI, (0x0 << 16)
LDEFCONST RCC_PLLSRC_HSE, (0x1 << 16)
LDEFCONST RCC_PLLMUL_MASK, (0xF << 18)
LDEFCONST RCC_PLLMUL_M12, (0b1010 << 18)
LDEFCONST RCC_USBPRE_MASK, (0x3 << 22)
LDEFCONST RCC_USBPRE_DIV2, (0x1 << 22)
LDEFCONST R32_RCC_INTR, 0x08
LDEFCONST R32_RCC_APB2PRSTR, 0x0C
LDEFCONST RCC_IOPA, (1 << 2)
LDEFCONST RCC_IOPB, (1 << 3)
LDEFCONST RCC_IOPC, (1 << 4)
LDEFCONST RCC_IOPD, (1 << 5)
LDEFCONST RCC_IOPE, (1 << 6)
LDEFCONST RCC_SPI1, (1 << 12)
LDEFCONST RCC_USART1, (1 << 14)
LDEFCONST R32_RCC_APB1PRSTR, 0x10
LDEFCONST RCC_USART3, (1 << 18)
LDEFCONST R32_RCC_AHBPCENR, 0x14
LDEFCONST RCC_RNG, (1 << 9)
LDEFCONST R32_RCC_APB2PCENR, 0x18
LDEFCONST R32_RCC_APB1PCENR, 0x1C
LDEFCONST R32_RCC_RSTSCKR, 0x24
LDEFCONST R32_RCC_CFGR2, 0x2C
LDEFCONST RCC_USBFSSRC_MASK, (0x1 << 31)
LDEFCONST RCC_USBFSSRC_PLL, (0x0 << 31)
LDEFCONST RCC_USBFSSRC_PHY, (0x1 << 31)

LDEFCONST EXTEN_BASE, 0x40023800
LDEFCONST R32_EXTEN_CTR, 0x00
LDEFCONST EXTEN_HSIPRE_MASK, (1 << 4)
LDEFCONST EXTEN_HSIPRE_DIV1, (1 << 4)
LDEFCONST EXTEN_HSIPRE_DIV2, (0 << 4)

LDEFCONST GPIOA_BASE, 0x40010800
LDEFCONST GPIOB_BASE, 0x40010C00
LDEFCONST R32_GPIO_CFGLR, 0x00
LDEFCONST GPIO_MODE_MASK, 0xF
LDEFCONST GPIO_MODE_FLOATIN, 0x4
LDEFCONST GPIO_MODE_PPOUT_50M, 0x3
LDEFCONST GPIO_MODE_MUPPOUT_50M, 0xB
LDEFCONST R32_GPIO_CFGHR, 0x04
LDEFCONST R32_GPIO_BSHR, 0x10

LDEFCONST UART1_BASE, 0x40013800
LDEFCONST UART2_BASE, 0x40004400
LDEFCONST UART3_BASE, 0x40004800
LDEFCONST R32_UART_STATR, 0x00
LDEFCONST UART_TC, (1 << 6)
LDEFCONST UART_RXNE, (1 << 5)
LDEFCONST R32_UART_DATAR, 0x04
LDEFCONST R32_UART_BRR,   0x08
LDEFCONST R32_UART_CTLR1, 0x0C
LDEFCONST UART_RE, (1 << 2)
LDEFCONST UART_TE, (1 << 3)
LDEFCONST UART_UE, (1 << 13)
LDEFCONST R32_UART_CTLR2, 0x10
LDEFCONST R32_UART_CTLR3, 0x14
LDEFCONST UART_RTSE, (1 << 8)
LDEFCONST R32_UART_GPR,   0x18
LDEFCONST R32_UART_CTLR4, 0x1C

LDEFCONST SPI1_BASE, 0x40013000
LDEFCONST R16_SPI_CTLR1, 0x00
LDEFCONST SPI_DFF8, (0 << 11)
LDEFCONST SPI_DFF16,(1 << 11)
LDEFCONST SPI_SSM_HW, (0 << 9)
LDEFCONST SPI_SSM_SW, (1 << 9)
LDEFCONST SPI_SSI_HIGH, (1 << 8)
LDEFCONST SPI_LSBFIRST, (1 << 7)
LDEFCONST SPI_SPE, (1 << 6)
LDEFCONST SPI_BR_MASK, (0x7 << 3)
LDEFCONST SPI_BR_DIV2, (0x0 << 3)
LDEFCONST SPI_BR_DIV4, (0x1 << 3)
LDEFCONST SPI_BR_DIV8, (0x2 << 3)
LDEFCONST SPI_BR_DIV16, (0x3 << 3)
LDEFCONST SPI_BR_DIV32, (0x4 << 3)
LDEFCONST SPI_BR_DIV64, (0x5 << 3)
LDEFCONST SPI_BR_DIV128, (0x6 << 3)
LDEFCONST SPI_BR_DIV256, (0x7 << 3)
LDEFCONST SPI_MSTR_SLAVE, (0 << 2)
LDEFCONST SPI_MSTR_MASTER, (1 << 2)
LDEFCONST R16_SPI_CTLR2, 0x04
LDEFCONST R16_SPI_STATR, 0x08
LDEFCONST SPI_TXE, (1 << 1)
LDEFCONST SPI_RXNE, (1 << 0)
LDEFCONST R16_SPI_DATAR, 0x0C
LDEFCONST R16_SPI_I2S_CFGR, 0x1C
LDEFCONST SPI_I2SMOD_SPI, (0 << 11)
LDEFCONST SPI_I2SMOD_I2S, (1 << 11)
LDEFCONST SPI_I2SE, (1 << 10)

LDEFCONST IWDG_BASE, 0x40003000
LDEFCONST R16_IWDG_CTLR, 0x00
LDEFCONST R16_IWDG_PSCR, 0x04
LDEFCONST R16_IWDG_RLDR, 0x08
LDEFCONST R16_IWDG_STATR, 0x0C

LDEFCONST RNG_BASE, 0x40023C00
LDEFCONST R32_RNG_CR, 0x00
LDEFCONST RNG_EN, (1 << 2)
LDEFCONST R32_RNG_SR, 0x04
LDEFCONST RNG_DRDY, (1 << 0)
LDEFCONST R32_RNG_DR, 0x08

LDEFCONST PFIC_BASE, 0xE000E000
LDEFCONST R32_PFIC_CFGR, 0x48
LDEFCONST R32_PFIC_IENR1, 0x100
LDEFCONST R32_PFIC_IENR2, 0x104
LDEFCONST R32_PFIC_IENR3, 0x108
LDEFCONST R32_PFIC_IRER1, 0x180
LDEFCONST R32_PFIC_IRER2, 0x184
LDEFCONST R32_PFIC_IRER3, 0x188
LDEFCONST R32_PFIC_IRER4, 0x18C

LDEFCONST SYSTICK_BASE, 0xE000F000
LDEFCONST R32_STK_CTLR, 0x00
LDEFCONST STK_STE, (1 << 0)
LDEFCONST STK_STIE, (1 << 1)
LDEFCONST STK_STCLK_DIV1, (1 << 2)
LDEFCONST STK_STCLK_DIV8, (0 << 2)
LDEFCONST STK_STCLK_MASK, (1 << 2)
LDEFCONST STK_STRE, (1 << 3)
LDEFCONST R32_STK_SR,   0x04
LDEFCONST R32_STK_CNTL, 0x08
LDEFCONST R32_STK_CNTH, 0x0C
LDEFCONST R32_STK_CMPLR, 0x10
LDEFCONST R32_STK_CMPHR, 0x14

LDEFCONST IRQN_NMI, 0x2
LDEFCONST IRQN_HARDFAULT, 0x3
LDEFCONST IRQN_ECALL_M, 0x5
LDEFCONST IRQN_BREAK_POINT, 0x9
LDEFCONST IRQN_SYSTICK, 0xC
LDEFCONST IRQN_SW, 0xE

        LDFW CH32_CHIPID, "CH32-CHIPID"
        PPUSH a5
	li a0, 0x1FFFF704
	lw a0, 0(a0)
	srli a5, a0, 20
	li a1, 0xFFF
	and a5, a5, a1
        ret
        ENDW CH32_CHIPID
	
	LDFW IRQ_ALL_OFF, "IRQ-ALL-OFF"
	li a0, 0x88
	csrc 0x800, a0
	fence.i
	ret
	ENDW IRQ_ALL_OFF

	LDFW IRQ_ALL_ON, "IRQ-ALL-ON"
	li a0, 0x88
	csrs 0x800, a0
	ret
	ENDW IRQ_ALL_ON

	LDFW SYS_RESET, "SYS-RESET"
	li a0, PFIC_BASE
	li a1, (0xBEEF << 16) | (1 << 7)
	sw a1, R32_PFIC_CFGR(a0)
1:	j 1b
	ENDW SYS_RESET
